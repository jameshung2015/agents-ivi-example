# 智能多Agent系统架构

## 架构概览

```
┌──────────────────────────────────────────────────────────────────┐
│                          用户界面层                                │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  Streamlit Web UI (app_supervisor.py)                     │  │
│  │  - 智能路由模式 / 手动选择模式                              │  │
│  │  - 实时统计显示                                             │  │
│  │  - 执行历史查看                                             │  │
│  │  - 可观测性控制                                             │  │
│  └────────────────────────────────────────────────────────────┘  │
└────────────────────────┬─────────────────────────────────────────┘
                         │
┌────────────────────────▼─────────────────────────────────────────┐
│                     Supervisor Agent 层                           │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  SupervisorAgent (supervisor_agent.py)                    │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │  │
│  │  │ 意图分析模块  │  │ 任务执行模块  │  │ 结果回收模块  │   │  │
│  │  │              │  │              │  │              │   │  │
│  │  │ LLM分析      │→ │ Agent选择    │→ │ 标准化封装    │   │  │
│  │  │ 关键词匹配    │  │ 任务分发      │  │ 元数据添加    │   │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘   │  │
│  │  ┌──────────────────────────────────────────────────────┐  │  │
│  │  │ 历史记录管理                                          │  │  │
│  │  │ - 任务历史存储 (100条限制)                            │  │  │
│  │  │ - Task ID生成和追踪                                   │  │  │
│  │  │ - 统计信息计算                                        │  │  │
│  │  └──────────────────────────────────────────────────────┘  │  │
│  └────────────────────────────────────────────────────────────┘  │
└────────────────────────┬─────────────────────────────────────────┘
                         │
              ┌──────────┼──────────┐
              │          │          │
┌─────────────▼──┐  ┌────▼─────┐  ┌▼────────────┐
│   Map Agent    │  │  Music   │  │   General   │
│                │  │  Agent   │  │   Dialog    │
│ ┌────────────┐ │  │ ┌──────┐ │  │             │
│ │POI Search  │ │  │ │QQ音乐│ │  │  Direct LLM │
│ │            │ │  │ │      │ │  │  Response   │
│ │Route Plan  │ │  │ │网易云│ │  │             │
│ └────────────┘ │  │ └──────┘ │  │             │
└────────┬───────┘  └────┬─────┘  └─────────────┘
         │               │
┌────────▼───────────────▼─────────────────────────────────────────┐
│                        工具层 (Tools)                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │高德地图API    │  │Chrome CDP     │  │  其他工具              │  │
│  │- POI搜索      │  │- QQ音乐控制   │  │  - 可扩展              │  │
│  │- 路径规划     │  │- 网易云控制    │  │                       │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
└──────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────┐
│                     可观测性层 (Observability)                    │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  ObservabilityManager (observability.py)                  │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │  │
│  │  │ 追踪管理  │  │ 事件记录  │  │ 指标收集  │  │ 数据导出  │ │  │
│  │  │          │  │          │  │          │  │          │ │  │
│  │  │ Traces   │  │ Events   │  │ Metrics  │  │ JSON导出  │ │  │
│  │  │(1000条)  │  │(1000条)  │  │(多维度)   │  │          │ │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘ │  │
│  └────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────┘
```

## 核心组件说明

### 1. Supervisor Agent

**职责**:
- 分析用户输入，识别任务类型
- 选择合适的子Agent执行任务
- 标准化处理和封装结果
- 管理任务执行历史
- 提供统计分析功能

**关键方法**:
```python
analyze_intent(user_input)     # 意图识别
execute_task(user_input, agent_type=None)  # 任务执行
get_task_history(limit=10)     # 获取历史
get_statistics()               # 获取统计
```

**设计模式**:
- 单例模式（全局唯一实例）
- 工厂模式（创建子Agent实例）
- 策略模式（不同的Agent策略）

### 2. Sub Agents

#### Map Agent
- **职责**: 处理地图相关查询
- **工具**: 
  - `amap_poi_search`: POI搜索
  - `amap_route_planner`: 路径规划
- **使用场景**: 地点查询、导航、路线规划

#### Music Agent
- **职责**: 处理音乐播放控制
- **工具**:
  - `qq_music_search_cdp`: QQ音乐搜索
  - `qq_music_play_cdp`: QQ音乐播放
  - `netease_music_search_cdp`: 网易云搜索
  - `netease_music_play_cdp`: 网易云播放
- **使用场景**: 音乐搜索、播放控制、平台切换

#### General Dialog
- **职责**: 处理一般性对话
- **实现**: 直接使用LLM回复
- **使用场景**: 闲聊、问答、其他非专业领域查询

### 3. Observability Manager

**职责**:
- 追踪系统执行过程
- 记录重要事件
- 收集性能指标
- 导出分析数据

**数据类型**:

1. **Traces (追踪)**
   ```python
   {
     "trace_id": "abc123",
     "span_name": "execute_task.start",
     "timestamp": "2025-01-01T12:00:00",
     "metadata": {...}
   }
   ```

2. **Events (事件)**
   ```python
   {
     "event_type": "agent_invocation",
     "timestamp": "2025-01-01T12:00:00",
     "data": {...}
   }
   ```

3. **Metrics (指标)**
   ```python
   {
     "agent.map.execution_time": [1.2, 1.5, 1.3, ...],
     "agent.music.success": [1, 1, 1, ...]
   }
   ```

### 4. Task Result

标准化的任务执行结果：

```python
class TaskResult:
    success: bool            # 是否成功
    agent_type: str          # 使用的Agent
    content: str             # 返回内容
    metadata: dict           # 元数据
    error: str               # 错误信息
```

## 数据流

### 请求流程

```
1. 用户输入
   ↓
2. Supervisor接收
   ↓
3. 意图分析 (LLM分类)
   ↓
4. Agent选择
   ↓
5. 子Agent执行
   ↓  ├→ Map Agent → 高德API
   ↓  ├→ Music Agent → Chrome CDP
   ↓  └→ General → LLM
   ↓
6. 结果回收
   ↓
7. 标准化封装 (TaskResult)
   ↓
8. 历史记录
   ↓
9. 返回用户
```

### 可观测性数据流

```
任务执行
   ↓
并行记录到:
   ├→ Traces (执行追踪)
   ├→ Events (重要事件)
   └→ Metrics (性能指标)
        ↓
   ObservabilityManager
        ↓
   定期导出到文件系统
```

## 扩展性设计

### 添加新Agent的步骤

1. **创建Agent文件**
   ```
   app/backend/agents/new_agent.py
   ```

2. **实现create_new_agent函数**
   ```python
   def create_new_agent():
       tools = [tool1, tool2]
       return create_agent(llm, tools, SYSTEM_PROMPT)
   ```

3. **注册到Supervisor**
   ```python
   # supervisor_agent.py
   self.sub_agents["new"] = create_new_agent()
   ```

4. **更新意图识别**
   ```python
   # 在analyze_intent中添加新类型
   "new: 新Agent的任务描述"
   ```

5. **更新前端**
   ```python
   # app_supervisor.py
   ["map", "music", "new", "general"]
   ```

### 添加新工具的步骤

1. **创建工具文件**
   ```
   app/backend/tools/new_tool.py
   ```

2. **实现工具函数**
   ```python
   @tool
   def new_tool(param: str) -> dict:
       """工具说明"""
       # 实现
       return result
   ```

3. **注册到tools/__init__.py**
   ```python
   from .new_tool import new_tool
   __all__ = [..., "new_tool"]
   ```

4. **添加到相应Agent**
   ```python
   tools = [existing_tool, new_tool]
   ```

## 性能优化

### 当前优化

1. **单例模式**: SupervisorAgent和ObservabilityManager使用单例，避免重复初始化
2. **容量限制**: 历史记录和可观测数据有容量限制，防止内存溢出
3. **延迟加载**: 子Agent在初始化时才创建

### 未来优化方向

1. **异步执行**: 使用async/await提升并发性能
2. **缓存机制**: 缓存常见查询结果
3. **批量处理**: 批量执行多个任务
4. **持久化**: 将历史数据持久化到数据库
5. **分布式**: 支持多实例部署和负载均衡

## 可靠性保障

### 错误处理

1. **层级错误捕获**
   - 工具层：捕获API错误
   - Agent层：捕获执行错误
   - Supervisor层：捕获路由错误

2. **降级策略**
   - 子Agent失败 → 回退到General对话
   - 意图识别失败 → 使用默认Agent
   - LLM调用失败 → 返回错误提示

### 监控告警

1. **性能监控**
   - 执行时间超过阈值
   - 成功率低于阈值
   - 内存使用过高

2. **业务监控**
   - Agent调用频率异常
   - 特定工具频繁失败
   - 用户输入模式变化

## 安全性

### 输入验证

1. **长度限制**: 限制用户输入长度
2. **内容过滤**: 过滤敏感信息和恶意内容
3. **速率限制**: 防止滥用和DoS攻击

### 数据安全

1. **敏感信息**: API密钥存储在环境变量
2. **数据脱敏**: 导出数据前移除敏感信息
3. **访问控制**: 限制可观测性数据的访问权限

## 总结

这个架构提供了：

✅ **清晰的分层**: UI层、路由层、执行层、工具层、可观测层
✅ **高可扩展性**: 易于添加新Agent和工具
✅ **完整可观测性**: 追踪、事件、指标三位一体
✅ **标准化接口**: 统一的任务执行和结果格式
✅ **容错机制**: 多层错误处理和降级策略
✅ **性能优化**: 单例模式、容量限制、延迟加载

通过这个架构，可以构建可靠、可维护、可扩展的多Agent系统。
